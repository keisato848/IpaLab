# 過去問データ統合機能 基本仕様書

## 1. 概要
本機能は、IPA（独立行政法人情報処理推進機構）が公開する情報処理技術者試験の過去問題（PDF）を取得し、AIを用いたOCR処理を経てアプリケーション（IPA Lab）で利用可能な形式に変換・統合するためのシステム群である。

## 2. 対象範囲
- **試験区分**:
    - 高度試験: ST (ITストラテジスト), SA (システムアーキテクト), PM (プロジェクトマネージャ), SC (情報処理安全確保支援士) 等
    - 基本・応用: FE (基本情報), AP (応用情報)
- **対象年度**:
    - 最新年度（随時追加）
    - レガシーデータ（2009年〜2021年）
        - ※2021年以前の高度試験（SA/ST等）は秋期開催を含む。

## 3. データ構造仕様

### 3.1 試験定義 (`exam-list.ts`)
各試験は以下のプロパティを持つオブジェクトとして定義される。

| 項目名     | 型     | 説明                                  | 例             |
| :--------- | :----- | :------------------------------------ | :------------- |
| `category` | string | 試験区分コード                        | `'ST'`, `'AP'` |
| `year`     | number | 西暦年度                              | `2019`         |
| `term`     | string | 実施時期 (`Spring` \| `Fall`)         | `'Fall'`       |
| `type`     | string | 試験種別 (`AM1`\|`AM2`\|`PM1`\|`PM2`) | `'PM1'`        |
| `url`      | string | 問題PDFのURL                          | `https://...`  |

### 3.2 中間データ (`questions_raw.json`)
抽出後のデータはJSON形式で保存される。

```json
{
  "questions": [
    {
      "qNo": 1,
      "text": "設問文...",
      "options": [ ... ], // 選択式の場合
      "subQuestions": [ ... ] // 記述式/大問の場合
    }
  ],
  "description": "全体の説明文（午後の大問など）"
}
```

### 3.3 データベーススキーマ (Cosmos DB)

#### `Exams` コンテナ
試験回ごとのメタデータ。
- `id`: `{Category}-{Year}-{Term}-{Type}` (例: `ST-2019-Fall-PM1`)
- `title`: 表示名 (例: `2019年度 秋期 ITストラテジスト 午後I`)

#### `Questions` コンテナ
個別の設問データ。
- `id`: `{ExamId}-{QNo}` (例: `ST-2019-Fall-PM1-1`)
- `examId`: パーティションキー
- `text`: 問題文
- `explanation`: 解説（AI生成）

## 4. 機能要件

### 4.1 ダウンロード機能
- **入力**: `exam-list.ts` の定義リスト
- **処理**: 定義されたURLからPDFをダウンロード。
- **出力**: `packages/data/data/raw_pdfs/` 配下のPDFファイル。
- **制約**: 既存ファイルはスキップすること（冪等性の担保）。

### 4.2 データ抽出機能 (ETL)
- **入力**: PDFファイル
- **処理**: Google Gemini API (Flash/Proモデル) を使用したOCRと構造化。
- **出力**: `questions_raw.json`, `answers_raw.json`
- **要件**:
    - 図表を含む複雑なレイアウトの認識。
    - APIレート制限への対応（リトライ、キーローテーション）。

### 4.3 クレンジング機能
- **入力**: Raw JSONファイル
- **処理**:
    - JSON構文エラーの自動修復。
    - 表記ゆれの統一。
    - 配点の自動按分（合計100点になるよう計算）。
- **出力**: 整形済みJSONファイル（上書き更新）。

### 4.4 同期機能
- **入力**: 整形済みJSONファイル
- **処理**: Azure Cosmos DB への Upsert。
- **要件**:
    - ローカルエミュレータとクラウド環境の両対応。
    - 不要になったデータ（PDFから削除された設問等）のPrune（削除）処理。

## 5. 非機能要件
- **拡張性**: 新しい試験区分や年度を容易に追加できる構成とすること。
- **性能**: 数百MB級のPDF処理においてもメモリエラーを起こさないこと（ストリーム処理等は現状不要だが、タイムアウト設定等は適切に行う）。
- **コスト**: AIモデルのトークン使用量を意識したプロンプト設計を行うこと。
